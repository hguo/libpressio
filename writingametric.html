<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libpressio: Writing a User Metrics Plugin</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libpressio
   &#160;<span id="projectnumber">0.41.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Writing a User Metrics Plugin </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>libpressio supports adding custom metrics plugins.</p>
<p>To create a metrics plugin, simply create a subclass of <code><a class="el" href="classlibpressio__metrics__plugin.html">libpressio_metrics_plugin</a></code> that implements the check that you are interested in, and register the plugin with libpressio.</p>
<p>For example, let's create a plugin that counts the number of compressions of each data type that the user preforms.</p>
<p>First we will include a number of required headers:</p>
<div class="fragment"><div class="line"><span class="comment">//required for all plugins</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="metrics_8h.html">libpressio_ext/cpp/metrics.h</a>&quot;</span> <span class="comment">// provides the libpressio_metrics_plugin</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="options_8h.html">libpressio_ext/cpp/options.h</a>&quot;</span> <span class="comment">// provides pressio_options and related methods</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="libpressio__ext_2cpp_2pressio_8h.html">libpressio_ext/cpp/pressio.h</a>&quot;</span> <span class="comment">// for the plugin registry</span></div><div class="line"></div><div class="line"><span class="comment">//required for this plugin</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="data_8h.html">libpressio_ext/cpp/data.h</a>&quot;</span> <span class="comment">// to be able to access -&gt;dtype()</span></div><div class="line"><span class="preprocessor">#include &lt;memory&gt;</span> <span class="comment">//for make_unique (in c++14 or later)</span></div><div class="line"><span class="preprocessor">#include &lt;map&gt;</span> <span class="comment">//for the map that counts what data type was used</span></div></div><!-- fragment --><p>Next, we need to write our class. Since we want to count the number of data buffers of each type that we compress, we will hook the <code>begin_compress</code> method. Alternatively we could also hook the <code>end_compress</code> method. Once we have the counts, we report them out using the <code>get_metrics_results</code> function. We do this like so:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>counting_metric: <span class="keyword">public</span> <a class="code" href="classlibpressio__metrics__plugin.html">libpressio_metrics_plugin</a> {</div><div class="line">  counting_metric() {</div><div class="line">    <span class="comment">//operator[] is non-const, so explicits instantiate each of the values we need</span></div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7acd6c5e78dd131ce6f45d7c881a9e739d">pressio_int8_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a554acdb44964602b3fcaa3b1b526c319">pressio_int16_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7afd7714c2d217225d3da3641024c0f107">pressio_int32_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7ab2869fdb2b1ec29ddf5735266f3e61f7">pressio_int64_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7ae0cd401a9c0828bd20291f8ea4c29279">pressio_uint8_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a9a0653ae11a646f291ca68bfbcd2b6ab">pressio_uint16_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7af37d0a42436b18d917a4039b1b3302bd">pressio_uint32_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a71ac34c5ddabcbb4b33c0e1d0d242dc2">pressio_uint64_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a7ada0fe39139abc830ae775dafc63885">pressio_float_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a1307b1ed406e56dbf2721b1f4966c0cf">pressio_double_dtype</a>] = 0;</div><div class="line">    counts[<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a0874be95fb4d4ffe55b162f39ddbef52">pressio_byte_dtype</a>] = 0;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">//increment the count at the beginning of each compress</span></div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="classlibpressio__metrics__plugin.html#a8c63607249473343f9dd68f07a08826d">begin_compress</a>(<a class="code" href="structpressio__data.html">pressio_data</a> <span class="keyword">const</span>* input, <a class="code" href="structpressio__data.html">pressio_data</a> <span class="keyword">const</span>*)<span class="keyword"> override </span>{</div><div class="line">    counts[input-&gt;<a class="code" href="structpressio__data.html#a5f5802d64d97c8874e52b5157aceb909">dtype</a>()]++;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">//return an options structure containing the metrics we care about</span></div><div class="line">  <span class="comment">//notice how the namespaced matches the name of the plugin that is registered below</span></div><div class="line">  <a class="code" href="structpressio__options.html">pressio_options</a> <a class="code" href="classlibpressio__metrics__plugin.html#a2cc3e240b0e633ac9b6156102dfd4710">get_metrics_results</a>()<span class="keyword"> const override </span>{</div><div class="line">    <a class="code" href="structpressio__options.html">pressio_options</a> opts;</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:int8&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7acd6c5e78dd131ce6f45d7c881a9e739d">pressio_int8_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:int16&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a554acdb44964602b3fcaa3b1b526c319">pressio_int16_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:int32&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7afd7714c2d217225d3da3641024c0f107">pressio_int32_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:int64&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7ab2869fdb2b1ec29ddf5735266f3e61f7">pressio_int64_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:uint8&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7ae0cd401a9c0828bd20291f8ea4c29279">pressio_uint8_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:uint16&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a9a0653ae11a646f291ca68bfbcd2b6ab">pressio_uint16_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:uint32&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7af37d0a42436b18d917a4039b1b3302bd">pressio_uint32_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:uint64&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a71ac34c5ddabcbb4b33c0e1d0d242dc2">pressio_uint64_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:float&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a7ada0fe39139abc830ae775dafc63885">pressio_float_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:double&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a1307b1ed406e56dbf2721b1f4966c0cf">pressio_double_dtype</a>));</div><div class="line">    <span class="keyword">set</span>(opts, <span class="stringliteral">&quot;counts:byte&quot;</span>, counts.at(<a class="code" href="pressio__dtype_8h.html#a06838f5680785d965f347017a79b10f7a0874be95fb4d4ffe55b162f39ddbef52">pressio_byte_dtype</a>));</div><div class="line">    <span class="keywordflow">return</span> opts;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="classpressio__configurable.html#ad1a78fa96a8aea6b4de765dc24e908af">prefix</a>()<span class="keyword"> const </span>{</div><div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;counts&quot;</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  std::map&lt;pressio_dtype, unsigned int&gt; counts;</div><div class="line">};</div></div><!-- fragment --><p>Finally, we will register the plugin in the under the names "counts" in the metrics plugging registry</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="classpressio__register.html">pressio_register</a> X(<a class="code" href="libpressio__ext_2cpp_2pressio_8h.html#af5af08883febed16d7ad1a424df6a685">metrics_plugins</a>(), <span class="stringliteral">&quot;counts&quot;</span>, [](){ <span class="keywordflow">return</span> std::make_unique&lt;counting_metric&gt;(); });</div></div><!-- fragment --><p>Then a user of the library can then ask libpressio to construct their new plugin as normal. But what if our metrics modules takes arguments? Instead of registering it directly, the user can instantiate it manually and combine it with others from the library using the <code>make_m_composite</code> method.</p>
<p>If your metric is suitably general and well implemented, you can contribute it back to libpressio. Metrics should be added to the <code>src/plugins/metrics/</code> directory and to the main <code>CMakeLists.txt</code>. If the metric requires additional dependencies beyond the standard library, it should be hidden behind a configuration flag that enables its use and disabled by default.</p>
<p>This full example can be found in the <code>test/test_regsiter_metrics.cc</code> file, and the full documentation of the allowed hooks and their arguments can be found in the documentation for <code><a class="el" href="classlibpressio__metrics__plugin.html">libpressio_metrics_plugin</a></code>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
