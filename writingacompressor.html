<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libpressio: Writing a Compressor Plugin</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libpressio
   &#160;<span id="projectnumber">0.41.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Writing a Compressor Plugin </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Libpressio supports adding custom compressor plugins.</p>
<p>To create a compressor plugin, simply create a subclass of <code><a class="el" href="classlibpressio__compressor__plugin.html">libpressio_compressor_plugin</a></code> that implements the compressor functions that you are interested in, and register the plugin with libpressio.</p>
<p>For example, let's create a compressor plugin that preforms a log transform as a preprocessing step to compression, and does a exponential transformation as a post processing step to decompression. Some scientific data compresses much better in the log domain than in the normal domain.</p>
<p>First you will need to include several headers.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span> <span class="comment">//for exp and log</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="data_8h.html">libpressio_ext/cpp/data.h</a>&quot;</span> <span class="comment">//for access to pressio_data structures</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="compressor_8h.html">libpressio_ext/cpp/compressor.h</a>&quot;</span> <span class="comment">//for the libpressio_compressor_plugin class</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="options_8h.html">libpressio_ext/cpp/options.h</a>&quot;</span> <span class="comment">// for access to pressio_options</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="libpressio__ext_2cpp_2pressio_8h.html">libpressio_ext/cpp/pressio.h</a>&quot;</span> <span class="comment">//for the plugin registries</span></div></div><!-- fragment --><p>First we are going to delegate most of the methods to the underlying compressor. To do so, we are going to do this in one of the most naive was possible and accept the compressor as a constructor argument. Then we are going to provide overrides that pass each of the methods to the underlying compressor.</p>
<p>Notice the function <code>check_error</code>. Since we are using composition rather than inheritance, we need to propagate error messages to our wrapper. The <code>check_error</code> function simply check for the error condition in the underlying function and propagates the error if these is one.</p>
<p>Also notice that we are using the <code>_impl</code> versions of the various methods. This is because the base class is doing some work to provide metrics functionality and basic error checking that we want to use.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>log_transform : <span class="keyword">public</span> <a class="code" href="classlibpressio__compressor__plugin.html">libpressio_compressor_plugin</a> {</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">  <span class="comment">//getting and setting options/configuration</span></div><div class="line">  <a class="code" href="structpressio__options.html">pressio_options</a> <a class="code" href="classlibpressio__compressor__plugin.html#aebe330db97b251195ef853360dbf4d0d">get_options_impl</a>()<span class="keyword"> const override </span>{</div><div class="line">    <span class="keyword">auto</span> options =  compressor.plugin-&gt;get_options();</div><div class="line">    <span class="keyword">set</span>(options, <span class="stringliteral">&quot;log:compressor&quot;</span>, compressor_id);</div><div class="line">    <span class="keywordflow">return</span> options;</div><div class="line">  }</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="classlibpressio__compressor__plugin.html#a2180d5ded80457937a4253ca792805b7">set_options_impl</a>(<a class="code" href="structpressio__options.html">pressio_options</a> <span class="keyword">const</span>&amp; options)<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordtype">int</span> rc = check_error(compressor.plugin-&gt;set_options(options));</div><div class="line">    std::string tmp;</div><div class="line">    <span class="keywordflow">if</span>(<span class="keyword">get</span>(options, <span class="stringliteral">&quot;log:compressor&quot;</span>, &amp;tmp) == <a class="code" href="pressio__options_8h.html#ae4dc79706eb8a9489e6f51b5bf71419caabfd446d878dd5e509dbdf479ab1a078">pressio_options_key_set</a>) {</div><div class="line">      <a class="code" href="structpressio.html">pressio</a> library;</div><div class="line">      <span class="keywordflow">if</span>(<span class="keyword">auto</span> tmp_compressor = library.<a class="code" href="structpressio.html#a991b34931e5c79f734887f8c9966f3b4">get_compressor</a>(tmp)) {</div><div class="line">        compressor = std::move(tmp_compressor);</div><div class="line">        compressor_id = std::move(tmp);</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="classpressio__errorable.html#ac88d68b1d28f24cf984fd2d2e7fc3bf4">set_error</a>(library.<a class="code" href="structpressio.html#aa4dee029147b85a8d6f119a11840bb5e">err_code</a>(), library.<a class="code" href="structpressio.html#a0c5049c51025b6b35788b9ce53c13837">err_msg</a>());</div><div class="line">      }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> rc;</div><div class="line">  }</div><div class="line">  <a class="code" href="structpressio__options.html">pressio_options</a> <a class="code" href="classlibpressio__compressor__plugin.html#ac7575b101042e5c216438e595af3c196">get_configuration_impl</a>()<span class="keyword"> const override </span>{</div><div class="line">    <span class="keywordflow">return</span> compressor.plugin-&gt;get_configuration();</div><div class="line">  }</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="classlibpressio__compressor__plugin.html#a3d2eda400213bf2a00d640328e6e8c75">check_options_impl</a>(<a class="code" href="structpressio__options.html">pressio_options</a> <span class="keyword">const</span>&amp; options)<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordflow">return</span> check_error(compressor.plugin-&gt;check_options(options));</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">//getting version information</span></div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="classpressio__configurable.html#ad1a78fa96a8aea6b4de765dc24e908af">prefix</a>()<span class="keyword"> const override </span>{</div><div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;log&quot;</span>;</div><div class="line">  }</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="classpressio__versionable.html#a610a79ec45e3ed5160efedd351914175">version</a>()<span class="keyword"> const override </span>{</div><div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;0.1.0&quot;</span>;</div><div class="line">  }</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="classpressio__versionable.html#af06e9af0f0af870c16358ca63596f6b9">major_version</a>()<span class="keyword"> const override </span>{</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="classpressio__versionable.html#aa18a0cf29f56b2ec2cdf242c22ce3786">minor_version</a>()<span class="keyword"> const override </span>{</div><div class="line">    <span class="keywordflow">return</span> 1;</div><div class="line">  }</div><div class="line">  <span class="keywordtype">int</span> <a class="code" href="classpressio__versionable.html#a1f1a2cf24aa1371a752d764a63b833d9">patch_version</a>()<span class="keyword"> const override </span>{</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line">  std::shared_ptr&lt;libpressio_compressor_plugin&gt; <a class="code" href="classlibpressio__compressor__plugin.html#aa97c5a43e80a019c74eda50f998a3a9d">clone</a>()<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordflow">return</span> compat::make_unique&lt;log_transform&gt;(*this);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">void</span> <a class="code" href="classpressio__configurable.html#ab9878c5ada9274daae95d743277c04a9">set_name_impl</a>(std::string <span class="keyword">const</span>&amp; new_name)<span class="keyword"> override </span>{</div><div class="line">    compressor-&gt;set_name(new_name + <span class="stringliteral">&quot;/&quot;</span> + compressor-&gt;prefix());</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordtype">int</span> check_error(<span class="keywordtype">int</span> rc) { </div><div class="line">    <span class="keywordflow">if</span>(rc) {</div><div class="line">      <a class="code" href="classpressio__errorable.html#ac88d68b1d28f24cf984fd2d2e7fc3bf4">set_error</a>(compressor-&gt;error_code(), compressor-&gt;error_msg());</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> rc;</div><div class="line">  }</div><div class="line">  <a class="code" href="structpressio__compressor.html">pressio_compressor</a> compressor = <a class="code" href="libpressio__ext_2cpp_2pressio_8h.html#ad6f9754206b4365612036f0d443a0a77">compressor_plugins</a>().build(<span class="stringliteral">&quot;noop&quot;</span>);</div><div class="line">  std::string compressor_id = <span class="stringliteral">&quot;noop&quot;</span>;</div><div class="line">}</div></div><!-- fragment --><p>Now to the harder part, writing compress and decompress.</p>
<p>First we can write our log and exponential transform functions.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>{</div><div class="line">  <span class="keyword">struct </span>log_fn{</div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;</div><div class="line">    <a class="code" href="structpressio__data.html">pressio_data</a> operator()(T* begin, T* end) {</div><div class="line">        <a class="code" href="structpressio__data.html">pressio_data</a> log_data = <a class="code" href="structpressio__data.html#a3f515cd75c19bb4e783853c2ae5fd961">pressio_data::clone</a>(*input);</div><div class="line">        <span class="keyword">auto</span> output_it = <span class="keyword">reinterpret_cast&lt;</span>T*<span class="keyword">&gt;</span>(log_data.<a class="code" href="structpressio__data.html#a0d9eaab5bbf23b34add82999099cf330">data</a>());</div><div class="line">        std::transform(begin, end, output_it, [](T i){ <span class="keywordflow">return</span> std::log(i); });</div><div class="line">        <span class="keywordflow">return</span> log_data;</div><div class="line">    }</div><div class="line">    <a class="code" href="structpressio__data.html">pressio_data</a> <span class="keyword">const</span>* input;</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="keyword">struct </span>exp_fn{</div><div class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;</div><div class="line">    <a class="code" href="structpressio__data.html">pressio_data</a> operator()(T* begin, T* end) {</div><div class="line">        <a class="code" href="structpressio__data.html">pressio_data</a> log_data = <a class="code" href="structpressio__data.html#a3f515cd75c19bb4e783853c2ae5fd961">pressio_data::clone</a>(*output);</div><div class="line">        <span class="keyword">auto</span> output_it = <span class="keyword">reinterpret_cast&lt;</span>T*<span class="keyword">&gt;</span>(log_data.<a class="code" href="structpressio__data.html#a0d9eaab5bbf23b34add82999099cf330">data</a>());</div><div class="line">        std::transform(begin, end, output_it, [](T i){ <span class="keywordflow">return</span> std::exp(i); });</div><div class="line">        <span class="keywordflow">return</span> log_data;</div><div class="line">    }</div><div class="line">    <a class="code" href="structpressio__data.html">pressio_data</a> <span class="keyword">const</span>* output;</div><div class="line">  };</div><div class="line">}</div></div><!-- fragment --><p>We will use these methods using the <code>pressio_data_for_each</code> API to preform the transform Now, we can write compress and decompress:</p>
<div class="fragment"><div class="line"><span class="comment">//compress and decompress</span></div><div class="line"><span class="keywordtype">int</span> compress_impl(<a class="code" href="structpressio__data.html">pressio_data</a> <span class="keyword">const</span>* input, <a class="code" href="structpressio__data.html">pressio_data</a>* output)<span class="keyword"> override </span>{</div><div class="line">  <a class="code" href="structpressio__data.html">pressio_data</a> log_input = pressio_data_for_each&lt;pressio_data&gt;(*input, log_fn{input});</div><div class="line">  <span class="keywordflow">return</span> check_error(compressor.<a class="code" href="structpressio__compressor.html#a73cb4457ef16ddeec93271ee2130f3e6">plugin</a>-&gt;compress(&amp;log_input, output));</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> decompress_impl(<a class="code" href="structpressio__data.html">pressio_data</a> <span class="keyword">const</span>* input, <a class="code" href="structpressio__data.html">pressio_data</a>* output)<span class="keyword"> override </span>{</div><div class="line">  <span class="keywordtype">int</span> rc =  compressor.<a class="code" href="structpressio__compressor.html#a73cb4457ef16ddeec93271ee2130f3e6">plugin</a>-&gt;decompress(input, output);</div><div class="line">  *output = pressio_data_for_each&lt;pressio_data&gt;(*output, exp_fn{output});</div><div class="line">  <span class="keywordflow">return</span> check_error(rc);</div><div class="line">}</div></div><!-- fragment --><p>We finally register the library with libpressio:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="classpressio__register.html">pressio_register</a> X(<a class="code" href="libpressio__ext_2cpp_2pressio_8h.html#ad6f9754206b4365612036f0d443a0a77">compressor_plugins</a>(), <span class="stringliteral">&quot;log&quot;</span>, [](){ <span class="keywordflow">return</span> std::make_unique&lt;log_transform&gt;();});</div></div><!-- fragment --><p>High quality compressor modules may be accepted into libpressio. Contributed modules should be placed in to the <code>src/plugins/compressors/</code> directory and added to the main CMakeLists.txt. If the compressor plugin requires an external dependency, it should be hidden behind a configuration option. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
