<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libpressio: Using the External Metric</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libpressio
   &#160;<span id="projectnumber">0.41.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Using the External Metric </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>LibPressio provides an <code>external</code> metrics module that runs a script or program provided by the user. This exists to better reuse existing analysis scripts or routines that users may wish to use without requiring them be ported to C++ and where upstreaming them does not make sense because they are too niche to be broadly applicable. In order to correctly communicate between LibPressio and an External script, strict communication semantics must be followed which may require writing a small wrapper in a high level language.</p>
<p>The external module is not intended to replace writing metrics modules in C/C++. Pull requests for such modules will not be accepted.</p>
<h2>Configuration Options</h2>
<p><em>New in external API 3</em> if the external metric script requires 2 or more input files, it MUST pass the <code>external:field_names</code> option with a length corresponding to the number of input files. Additionally, if other arguments taking a array of strings are passed, their length must equal the number of input files or be 0 or be unset. If the length is 0 or unset, a default option will be used for each input file. If the length is non-zero, the ith option corresponds to the ith file.</p>
<table class="doxtable">
<tr>
<th>Option </th><th>Version Added </th><th>Type </th><th>Description  </th></tr>
<tr>
<td><code>external:command</code> </td><td>1 </td><td><code>char*</code> </td><td>the command to execute, the options passed by the module will be appended to this string </td></tr>
<tr>
<td><code>external:io_format</code> </td><td>2 </td><td><code>char*[]</code> </td><td>the format to write the data to disk. It can be any format supported by <code>pressio_supported_io_modules</code> The ith entry in the list corresponds to the ith input file. </td></tr>
<tr>
<td><code>external:field_names</code> </td><td>3 </td><td><code>char*[]</code> </td><td>the prefix to use for arguments relating to the files. For example, if the list <code>["foo"]</code> is provided, arguments would be like <code>--foo_dim</code>. If this list is empty, The script will be passed arguments of the form <code>--dim</code>. </td></tr>
<tr>
<td><code>external:prefix</code> </td><td>3 </td><td><code>char*[]</code> </td><td>the prefix to use for arguments relating to the files. The default is an empty prefix. </td></tr>
<tr>
<td><code>external:suffix</code> </td><td>3 </td><td><code>char*[]</code> </td><td>the suffix to use for arguments relating to the files. The default is an empty suffix. </td></tr>
<tr>
<td><code>external:work_dir</code> </td><td>3 </td><td><code>char*</code> </td><td>the path to call the script from, defaults to the current working directory </td></tr>
<tr>
<td><code>external:launch_method</code> </td><td>3 </td><td><code>char*</code> </td><td>the method used to launch the worker task. It can be one of "forkexec" or "mpispawn" </td></tr>
<tr>
<td><code>external:config_name</code> </td><td>4 </td><td><code>char*</code> </td><td>A string passed to the external metric for the "configuration name", by default "external" </td></tr>
</table>
<p><em>New in external API 2</em> "global" IO module options may passed as well.</p>
<p><em>New in external API 3</em> If <code>external:field_names</code> is unset and the metrics module is unnamed, the IO module will also be assigned the name <code>external</code>. If <code>external:field_names</code> is unset and the metrics module is named, the IO module will be assigned the same name as the external metric module. If <code>external:field_names</code> is set, the IO modules used will be assigned names according the field names. If the external metric is unnamed, the io module that writes out the <code>x</code> field will be assigned the name <code>x</code>. If the external metric is assigned a name, the io module is a assigned the name of the external metric followed by a <code>/</code> followed by the field name. For example, if the external metric name is<code>imaging_metric</code>, and the field name is <code>x</code>, the io module that writes out the x field will be assigned the name <code>imaging_metric/x</code>.</p>
<h2>"Well-Known" Command line Arguments</h2>
<p>The <code>external</code> plugin will provide the following command line arguments to the script. These may change from version to version.</p>
<p><code>--api</code> the maximum API version number the external module supports, begins at 1. The current version is 5</p>
<p><em>New in external API 4</em> <code>--config_name</code> the value passed to the <code>external:config_name</code> option. The implementation <em>may</em> use this value to as a basis to name log files or other auxiliary outputs.</p>
<p><b>New Requirement in API 3</b> If the script is called with zero of the following well-known arguments, it MUST output a lists of the known results with default values in-case they are omitted from calls to the script when called with some set of well-known flags. Scripts MAY return different lists of values when called with defined custom arguments. See the example below</p>
<p><em>New in external API 3</em> The following arguments will be "prefixed" according to the <code>external:field_names</code> argument if it is set. See the table above in "Configuration Options" and example usage below.</p>
<p><code>--input</code> path to a temporary file containing the input data prior to compression. (new in version 2) It will be according to the <code>external:io_format</code> option</p>
<p><code>--decompressed</code> path to a temporary file containing the input data prior to compression. (new in version 2) It will be according to the <code>external:io_format</code> option</p>
<p><code>--dim</code> dimension the dimensions of the dataset from low to high. This argument may be passed more than once. If passed more than once, the dimensions are given in order same order as the <code>pressio_data_new</code> functions.</p>
<p><code>--type</code> type of the input data. Valid types include: "float", "double", "int8", "int16", "int32", "int64", "uint8", "uint16", "uint32", "uint64", "byte".</p>
<h2>"Custom Defined" Command line Arguments</h2>
<p>It <b>is</b> guaranteed, that no future arguments will use names beginning with <code>external</code> and may be safely used for custom arguments specified by the user.</p>
<h2>Error Codes</h2>
<p>External Metrics indicates it's own status (as opposed to the script's status) using the <code>external:error_code</code> parameter. Here are the values it can be:</p>
<table class="doxtable">
<tr>
<th>Value </th><th>Meaning  </th></tr>
<tr>
<td>0 </td><td>Successful launch </td></tr>
<tr>
<td>1 </td><td>Pipe Error &ndash; failed to create the pipe </td></tr>
<tr>
<td>2 </td><td>Fork Error &ndash; failed to create the child process </td></tr>
<tr>
<td>3 </td><td>Exec Error &ndash; failed to exec the child process to the script </td></tr>
<tr>
<td>4 </td><td>Format Error &ndash; the script returned output that the module did not understand </td></tr>
</table>
<h2>Example Usage</h2>
<p><code>/path/to/script --input /tmp/input.f32 --decompressed /tmp/decompressed.f32 --dim 500 --dim 500 --dim 100 --type float</code></p>
<p>In this case <code>external:command</code> is set to <code>/path/to/script</code></p>
<p><code>/usr/bin/env python myscript.py --input /tmp/input.f32 --decompressed /tmp/decompressed.f32 --dim 500 --dim 500 --dim 100 --type float</code></p>
<p>In this case <code>external:command</code> is set to <code>/usr/bin/env python myscript.py</code></p>
<p><code>/path/to/script --foo_input /tmp/foo_input.f32 --foo_decompressed /tmp/decompressed.f32 --foo_dim 500 --foo_dim 500 --foo_dim 100 --foo_type float</code></p>
<p>In this case, <code>external:command</code> is set to <code>/path/to/script</code> and <code>external:feild_names</code> is set to `['foo']`</p>
<p><code>/path/to/script --external_custom_arg 3</code></p>
<p>In this case, <code>external:command</code> is set to <code>/path/to/script --external_custom_arg 3</code>. Where <code>--external_custom_arg</code> is a script defined custom argument.</p>
<p><b>NOTE</b> the names provided in this example are illustrative only, the real names are generated by <code>mkstemp</code></p>
<h1>Non Guarantees</h1>
<p>All of the above arguments MAY not be passed in later versions of the API.</p>
<p>The order of the command line arguments is unspecified and may be passed in any order unless other wise noted (i.e. dimensions are passed in the same order as to one of the <code>pressio_data_new</code> functions).</p>
<p>The <code>external</code> plugin may pass additional command line arguments not specified here. It <b>is</b> guaranteed, that no future arguments will use names beginning with <code>external</code> and may be safely used for custom arguments specified by the user.</p>
<p>The environment of the script is unspecified.</p>
<p>Do not assume that your command is passed to a shell.</p>
<h1>"forkexec" launch method</h1>
<h2>Version 1</h2>
<h3>Expected Standard Output</h3>
<p>A line <code>external:api=$version_number\n</code> where <code>$version_number</code> is a positive integer.</p>
<p>After the API line, one or more lines conforming to the following pattern:</p>
<p><code>$var_name=$value\n</code></p>
<p>Where:</p>
<ul>
<li><code>$var_name</code> is any string that does not contain a literal ascii <code>=</code> or <code>\n</code> character. It may not begin with the prefix <code>external:</code>.</li>
<li><code>=</code> is a literal ascii "=" character</li>
<li><code>$value</code> is a value that can be parsed using <code>strtod</code></li>
<li><code>\n</code> is a newline character</li>
</ul>
<p>An example output could be:</p>
<div class="fragment"><div class="line">external:api=1</div><div class="line">auto_cor1=.099</div><div class="line">auto_cor2=.099</div><div class="line">auto_cor3=.097</div><div class="line">ssim=.64</div><div class="line">my_analysis=1.03e-3</div></div><!-- fragment --><h3>Expected Standard Error</h3>
<p>If the return code is non-zero, a warning or error message SHOULD be printed to stderr. It SHOULD be a human readable message designed for use in debugging.</p>
<p>These warnings/errors will be reported to the user with in the <code>metric_results</code> under the key <code>external:stderr</code>.</p>
<p>An example output could be:</p>
<div class="fragment"><div class="line">foobar analysis only supports being run on 2d data</div></div><!-- fragment --><h3>Expected Return Code</h3>
<p>The external command is expected to return 0 on success, positive values on an error, and negative on warning.</p>
<h3>Example</h3>
<p>Assume that an external metrics module ran and exited with a return code of 1 generating the output above will generate following keys in an arbitrary order.</p>
<div class="fragment"><div class="line">external:results:auto_cor1=.099</div><div class="line">external:results:auto_cor2=.099</div><div class="line">external:results:auto_cor3=.097</div><div class="line">external:results:ssim=.64</div><div class="line">external:results:my_analysis=1.03e-3</div><div class="line">external:return_code=1</div><div class="line">external:error_code=0</div><div class="line">external:stderr=&quot;foobar analysis only supports being run on 2d data&quot;</div></div><!-- fragment --><h2>Version 2</h2>
<p>No changes were made to the output format since version 1.</p>
<h2>Version 3</h2>
<p>The output from a script has changed to reflect the zero well-known argument case. Otherwise the format is unchanged.</p>
<h3>Expected Standard Output</h3>
<p><b>New requirement in external API 3</b> If the script is called with zero well-known arguments, an example output could be:</p>
<div class="fragment"><div class="line">external:api=1</div><div class="line">auto_cor1=0.0</div><div class="line">auto_cor2=0.0</div><div class="line">auto_cor3=0.0</div><div class="line">ssim=0.0</div><div class="line">my_analysis=0.0</div><div class="line">foobar=2.7</div></div><!-- fragment --><h3>Example</h3>
<p>Assume that an external metrics module ran and exited with a return code of 1 generating the output above will generate following keys in an arbitrary order.</p>
<div class="fragment"><div class="line">external:results:auto_cor1=.099</div><div class="line">external:results:auto_cor2=.099</div><div class="line">external:results:auto_cor3=.097</div><div class="line">external:results:ssim=.64</div><div class="line">external:results:my_analysis=1.03e-3</div><div class="line">external:results:foobar=2.7</div><div class="line">external:return_code=1</div><div class="line">external:error_code=0</div><div class="line">external:stderr=&quot;foobar analysis only supports being run on 2d data&quot;</div></div><!-- fragment --><p><b>Note</b> that <code>external:results:foobar</code> only appears in the zero well-known argument version of the output. It is thus presented with its default value.</p>
<h2>Version 4</h2>
<p>No changes were made to the output format. The <code>--config_name</code> argument was introduced</p>
<h1>Version 5</h1>
<p>No changes were made to the output format. A double field <code>external:duration</code> is now included for external metrics which contains the runtime in seconds.</p>
<h1>"mpispawn" launch method</h1>
<p>This method spawns the exernal metric using the <code>MPI_Comm_spawn</code> routine with a series of calls similar to the following:</p>
<div class="fragment"><div class="line">std::vector&lt;char*&gt; args; <span class="comment">// contains the command line arguments beginning with</span></div><div class="line">                         <span class="comment">// the name of the executable and ending with an nullptr</span></div><div class="line">MPI_Info info;</div><div class="line">MPI_Info_create(&amp;info);</div><div class="line">MPI_Info_set(info, <span class="stringliteral">&quot;wdir&quot;</span>, workdir.c_str());</div><div class="line">MPI_Comm_spawn(args.front(), args.data()+1, 1, info, 0,  MPI_COMM_SELF, &amp;child, &amp;error_code); </div></div><!-- fragment --><h2>Version 1 and 2</h2>
<p>The <code>mpispawn</code> launch method does not support external metrics api versions 1 or 2.</p>
<h2>Version 3 - 5</h2>
<p>Equivelent to <code>forkexec</code> with the following exceptions.</p>
<p>Instead of connecting standard out and standard error, the external script should communicate with the external metric module using a series of MPI calls presented below.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> status_code = 0;    <span class="comment">//a status code; see `forkexec` return code</span></div><div class="line">std::string stdout_str; <span class="comment">//the output of the external metric; see `forkexec` format for stdout</span></div><div class="line">std::string stderr_str; <span class="comment">//the output of the external metric; see `forkexec` format for stderr</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> stdout_len = stdout_str.size();</div><div class="line"><span class="keywordtype">int</span> stderr_len = stderr_str.size();</div><div class="line"></div><div class="line">MPI_Comm parent;</div><div class="line">MPI_Comm_get_parent(&amp;parent);</div><div class="line">MPI_Send(&amp;status_code, 1, MPI_INT, 0, 0, parent);</div><div class="line">MPI_Send(&amp;stdout_len, 1, MPI_INT, 0, 0, parent);</div><div class="line">MPI_Send(stdout_str.c_str(), stdout_len, MPI_CHAR, 0, 0, parent);</div><div class="line">MPI_Send(&amp;stderr_len, 1, MPI_INT, 0, 0, parent);</div><div class="line">MPI_Send(stderr_str.c_str(), stderr_len, MPI_CHAR, 0, 0, parent);</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
